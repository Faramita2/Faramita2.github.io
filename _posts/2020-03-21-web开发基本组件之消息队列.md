---
layout: post
title: "web开发基本组件之消息队列"
---

>前些日子，在做电商后台发放优惠券的功能时，和同事说到做这个的时候，同事说道：“一次性发放这么多优惠券出去，对数据库会操作很多吧，你可能要使用`消息队列`延迟执行任务”。由此开启了我对`消息队列`的认识和使用。

# 什么是消息队列(message queue)？

这里首先要分解开来，消息队列分为消息(message)和队列(queue)两部分，这两部分的定义单独拆开来的含义是什么呢。

消息(message)是指程序之间传输的一种约定好格式的数据。有可能是一个需要即将执行的任务，有可能是完成任务的数据，也有可能是一段纯文本。

队列(queue)是一种数据结构，其最基本的特点是`先进先出`(FIFO: First In First out)。

综合上述两者组成的基本概念，可以得知，消息队列(message queue)是一种程序之间传输消息或者下发任务等用途的队列，在消息队列中，产生消息的程序方一般被称为生产者(producer)，而接收消息(数据)或者处理任务的程序方被称为消费者(consumer)。

# 消息队列的特性(feature)?

消息队列(message queue)最重要的特性就是提供了一种程序之间异步通讯的协议。在一个很通常的例子邮件可以找到消息队列的影子。试想，每当发送或接收一封邮件时，发送方或接收方是否需要同时在线在客户端等着呢？不需要。为什么？在这种情况下，邮件被发送出来，都在服务器上被保存起来，放入消息队列等待客户端上线或者手动拉取时，才被消息队列的弹出，并下发到用户客户端。

可以见得消息队列很明显的一个地方在于`异步`，应用程序之间不需要同步的响应和处理，继续抽象来，这就是解耦(decouple)。因为在一定意义上，当两个应用之间不需要同步去执行和响应，可以理解为两者的关系淡化，分开去处理和实现。

在此基础之上，消息队列解耦了许多大型应用子应用的之间的关联，使它们之间不再那么紧密，又有了很多的想象空间。比如，拆分更细致之后，开发的分工更为明确，由于解耦了复杂的应用，故障和bug的数量会下降，专注于某个模块会更细致，开发的效率也会提升。

# 消息队列的应用(use case)？

Google了一些资料，发现对于消息队列的使用用例而言，并没有特别针对性的例子，也可以理解为是，这种组件基础到，只要是有合适的场景便能够使用。用我看到的一句话而言就是：任何不需要立即产生效果或并非基础任务都可以使用上消息队列。

尽管如此，还是举一些实际的例子，让这句话的含义更为具体一点，也有助于深化和形象概念：

1. 图片的裁剪。很多情况下，用户上传的图片都不会用到原始的大小（绝大多数情况），因为用户上传的图片大小都不一致。而且在某些情况下，比如上传用户头像，会需要一个略缩图来在一些特定场合显示，而不是原图。对于这种任务，可以使用消息队列在后台执行：在前台用户上传后，把裁剪的任务推到消息队列，随后直接响应返回。这样做的好处是提升了用户体验，用户不需要等待裁剪过程。
2. 发送邮件。在前面说消息队列特性的地方说到了邮件，这里重提一下是具体流程。在很多场景下，比如用户注册成功、订单支付成功、发送邮箱验证码时，应用需要发送一封邮件到用户邮箱中，由于这种服务的普遍性以及不完全即时的特点。使用消息队列将发送邮件的任务指派到专门的发送邮件服务，能够更好的解耦，可以想象，当一个应用或者多个应用都有这样的服务时，邮件服务完全可以独立成一个应用，为其他应用专门服务邮件，这样专注开发，在开发、测试、运维等多个方面都提升了效率，减少了复杂的关联。
3. 多任务处理。这个在我看来有些抽象，这种场景是指某些相同类型的任务如果不需要即时的效果，而对数据库有写入的操作。那么这种任务可以通过消息队列存起来，达到一定量或指定时间同时去处理，因为对于数据库而言，插入1条和插入1000条都是可以用一条sql语句完成的，如果把1000条分多次写入，开销肯定比一次要大得多。于是消息队列可以节省不必要的开销，节约成本。
4. 秒杀队列。秒杀这种营销活动，用户产生的请求和实际能处理的请求差距很大，为了排除无效的请求和节省开销成本，应用开发需要考虑到筛选过滤掉大量重复和无效的请求，并且使用一种机制只处理部分有效的请求。消息队列在这种场景下可能发挥出巨大的作用，当大量请求从客户端发送到服务端时，服务端的web服务器将请求发送给对请求过滤的一层应用网关中，网关的功能不多，就是过滤请求，并把有效的请求推入消息队列，真正的业务应用则从消息队列逐步取出有效的请求，使得整个过程业务服务器不会由于处理大量的请求而崩溃，并且在整个架构中，可以因为消息队列的存在解耦得更为彻底，做到各做各份内的事情，让整个分工更明确，职责更具体。

当然，由于个人的理解不够深刻加上web开发的经验还太浅，消息队列的使用其实还有很多很多，可能在今后越来越多的开发过程中会有更多的理解，再写出来。

# 最后
其实有悟到一些东西，在开发这一块，并没有说一定要使用什么或者掌握什么技术，只是在不断演变的过程中，许多前人发现并将自己的实践经验分享出来，随后改变了整个行业。这是一种思想的革命，在变化中不变的是追求更高更好的心，而且，是用于探索和改变的态度，我想这也是我应该值得去学习和理解的！